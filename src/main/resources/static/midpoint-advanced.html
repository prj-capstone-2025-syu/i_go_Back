<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤ë§ˆíŠ¸ ì¤‘ê°„ìœ„ì¹˜ ì°¾ê¸° í…ŒìŠ¤íŠ¸</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif; max-width: 600px; margin: 20px auto; padding: 20px; background-color: #f7f9fc; }
        .container { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        h1 { color: #333; text-align: center; margin-bottom: 20px; }
        .chat-section { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        textarea { width: 100%; box-sizing: border-box; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; resize: vertical; min-height: 60px; }
        button { background-color: #007aff; color: white; width: 100%; padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; margin-top: 10px; }
        button:hover { background-color: #0056b3; }
        .reset-btn { background-color: #6c757d; margin-top: 5px; }
        .reset-btn:hover { background-color: #5a6268; }
        .chat-history { margin-top: 20px; height: 400px; overflow-y: auto; border: 1px solid #e5e5e5; padding: 15px; background-color: #fff; border-radius: 8px; }
        .message { margin-bottom: 12px; padding: 10px 15px; border-radius: 18px; max-width: 85%; line-height: 1.5; }
        .user-message { background-color: #007aff; color: white; margin-left: auto; border-bottom-right-radius: 4px; }
        .bot-message { background-color: #e9ecef; color: #333; margin-right: auto; border-bottom-left-radius: 4px; white-space: pre-wrap; } /* white-space ì¶”ê°€ */
        small { display: block; text-align: center; color: #888; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ—ºï¸ AI ì¤‘ê°„ì¥ì†Œ ì°¾ê¸°</h1>

        <div class="chat-section">
            <label for="smartMessage">ë©”ì‹œì§€ ì…ë ¥:</label>
            <textarea id="smartMessage" placeholder="AIì˜ ì§ˆë¬¸ì— ë‹µë³€í•´ì£¼ì„¸ìš”..."></textarea>
            <small>AI ì§ˆë¬¸ ìˆœì„œ: ì¸ì›ìˆ˜ â†’ ê°ì ì¶œë°œ ìœ„ì¹˜</small>

            <button onclick="sendMessage()">ì „ì†¡</button>
            <button class="reset-btn" onclick="resetSession()">ëŒ€í™” ì´ˆê¸°í™”</button>

            <div class="input-group" style="margin-top: 20px;">
                <label>ëŒ€í™” ë‚´ìš©:</label>
                <div id="chatHistory" class="chat-history"></div>
            </div>
        </div>
    </div>

    <script>
        let chatHistory = [];

        async function sendMessage() {
            const messageInput = document.getElementById('smartMessage');
            const message = messageInput.value;

            if (!message.trim()) return;

            addToChatHistory('user', message);
            messageInput.value = '';
            // ë©”ì‹œì§€ ì „ì†¡ ì¤‘ ë²„íŠ¼ ë¹„í™œì„±í™” (ì„ íƒì )
            toggleButtons(false);

            try {
                // [ìˆ˜ì •] í† í° ì²˜ë¦¬ ë¡œì§ì€ ë°±ì—”ë“œì—ì„œ í•˜ë¯€ë¡œ ì œê±° ë˜ëŠ” ì£¼ì„ ì²˜ë¦¬
                // const token = localStorage.getItem('access_token');
                // if (!token) {
                //     addToChatHistory('bot', 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                //     toggleButtons(true);
                //     return;
                // }

                const response = await fetch('/api/midpoint/smart', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // 'Authorization': 'Bearer ' + token // ë°±ì—”ë“œì—ì„œ Spring Securityê°€ ì²˜ë¦¬
                    },
                    body: JSON.stringify({ message: message })
                });

                // HTTP ìƒíƒœ ì½”ë“œ í™•ì¸
                if (!response.ok) {
                    // ì„œë²„ì—ì„œ JSON í˜•íƒœì˜ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ê²½ìš° íŒŒì‹± ì‹œë„
                    let errorMsg = `ì„œë²„ ì˜¤ë¥˜ ë°œìƒ (${response.status})`;
                    try {
                        const errorData = await response.json();
                        errorMsg = errorData.message || errorMsg;
                    } catch (e) { /* ignore parsing error */ }
                    throw new Error(errorMsg);
                }

                const data = await response.json();
                addToChatHistory('bot', data.message || JSON.stringify(data, null, 2));

            } catch (error) {
                addToChatHistory('bot', 'ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
            } finally {
                // ë©”ì‹œì§€ ì²˜ë¦¬ ì™„ë£Œ í›„ ë²„íŠ¼ í™œì„±í™” (ì„ íƒì )
                toggleButtons(true);
            }
        }

        async function resetSession() {
            // ë¦¬ì…‹ ì¤‘ ë²„íŠ¼ ë¹„í™œì„±í™” (ì„ íƒì )
            toggleButtons(false);
            try {
                 // const token = localStorage.getItem('access_token');
                // if (!token) {
                //     addToChatHistory('bot', 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                //     toggleButtons(true);
                //     return;
                // }

                const response = await fetch('/api/midpoint/reset', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // 'Authorization': 'Bearer ' + token
                    }
                });

                if (!response.ok) {
                    let errorMsg = `ì„¸ì…˜ ì´ˆê¸°í™” ì‹¤íŒ¨ (${response.status})`;
                    try { const errorData = await response.json(); errorMsg = errorData.message || errorMsg; } catch (e) {}
                    throw new Error(errorMsg);
                }

                const data = await response.json();
                chatHistory = []; // í´ë¼ì´ì–¸íŠ¸ ì¸¡ íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™”
                addToChatHistory('bot', data.message || 'ì„¸ì…˜ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ì²˜ìŒë¶€í„° ì‹œì‘í•©ë‹ˆë‹¤.');

            } catch (error) {
                addToChatHistory('bot', 'ì„¸ì…˜ ì´ˆê¸°í™” ì˜¤ë¥˜: ' + error.message);
            } finally {
                // ë¦¬ì…‹ ì™„ë£Œ í›„ ë²„íŠ¼ í™œì„±í™” (ì„ íƒì )
                toggleButtons(true);
            }
        }

        function addToChatHistory(sender, message) {
            chatHistory.push({ sender, message });
            updateChatHistory();
        }

        function updateChatHistory() {
            const chatDiv = document.getElementById('chatHistory');
            chatDiv.innerHTML = '';
            chatHistory.forEach(chat => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${chat.sender}-message`;
                // í…ìŠ¤íŠ¸ ë‚´ìš©ìœ¼ë¡œ ì„¤ì • (HTML íƒœê·¸ ë°©ì§€)
                messageDiv.textContent = chat.message;
                chatDiv.appendChild(messageDiv);
            });
            chatDiv.scrollTop = chatDiv.scrollHeight; // í•­ìƒ ë§¨ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ëŒ€í™” ì‹œì‘ (ìë™ ë¦¬ì…‹)
        document.addEventListener('DOMContentLoaded', function() {
            resetSession();
        });

        // Enter í‚¤ë¡œ ë©”ì‹œì§€ ì „ì†¡ (Shift+EnterëŠ” ì¤„ë°”ê¿ˆ)
        document.getElementById('smartMessage').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // ê¸°ë³¸ Enter ë™ì‘(ì¤„ë°”ê¿ˆ) ë°©ì§€
                sendMessage();
            }
        });

        // ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™” í•¨ìˆ˜ (ì„ íƒì )
        function toggleButtons(enabled) {
            document.querySelectorAll('button').forEach(btn => btn.disabled = !enabled);
            document.querySelector('textarea').disabled = !enabled;
        }
    </script>
</body>
</html>