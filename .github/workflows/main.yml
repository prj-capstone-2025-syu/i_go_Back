name: Spring Boot Blue-Green Deploy

on:
  push:
    branches: [ master ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      SPRING_PROFILES_ACTIVE: prod
      IMAGE_NAME: igo-backend
      CONTAINER_BLUE: backend-blue
      CONTAINER_GREEN: backend-green
      NGINX_TARGET_FILE: /etc/nginx/conf.d/backend.target

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Generate application.properties from secret
        run: |
          mkdir -p ./src/main/resources
          cat <<EOF > ./src/main/resources/application.properties
          ${{ secrets.APPLICATION_PROPERTIES }}
          EOF

      - name: Generate Firebase Admin SDK JSON from secret
        run: |
          mkdir -p ./src/main/resources/firebase
          echo '${{ secrets.FIREBASE_ADMINSDK_JSON }}' > ./src/main/resources/firebase/igo-project-56559-firebase-adminsdk-fbsvc-ddd43a3897.json

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Grant execute permission to Gradle
        run: chmod +x ./gradlew

      - name: Build with Gradle (Skip Tests)
        run: ./gradlew clean build -x test --no-daemon

      - name: Build Docker Image
        run: |
          # 플랫폼을 명시하여 호환성 문제 방지
          docker build --platform linux/amd64 -t ${{ env.IMAGE_NAME }}:${{ github.sha }} .
          docker save ${{ env.IMAGE_NAME }}:${{ github.sha }} -o backend-image.tar

      - name: Copy Docker Image to EC2
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "backend-image.tar"
          target: "/home/ubuntu/igo"

      - name: Blue-Green Deploy on EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          timeout: 40m 
          script: |
            cd /home/ubuntu/igo
            
            echo "1. Loading Docker Image..."
            # 로드 실패 시 파일 삭제
            if sudo docker load -i backend-image.tar; then
              echo "Image loaded successfully."
              rm -f backend-image.tar
            else
              echo "Error: Failed to load image. Cleaning up..."
              rm -f backend-image.tar
              exit 1
            fi
            
            # Docker Compose 네트워크가 없으면 생성
            if ! sudo docker network ls | grep -q igo_default; then
              sudo docker network create igo_default
              echo "Created igo_default network"
            fi
            
            # MySQL 컨테이너 네트워크 확인
            MYSQL_NETWORK=$(sudo docker inspect $(sudo docker ps --filter "expose=3306" -q) --format='{{range $k, $v := .NetworkSettings.Networks}}{{$k}}{{end}}' | head -1)
  
            if [ -z "$MYSQL_NETWORK" ]; then
              echo "MySQL container not found or not running!"
              exit 1
            fi
  
            echo "MySQL is running on network: $MYSQL_NETWORK"
            
            BLUE_PORT=8080
            GREEN_PORT=8081
            
            # 현재 실행 중인 컨테이너 확인 및 타겟 결정
            if sudo docker ps | grep -q ${{ env.CONTAINER_BLUE }}; then
              ACTIVE_CONTAINER=${{ env.CONTAINER_BLUE }}
              NEW_CONTAINER=${{ env.CONTAINER_GREEN }}
              NEW_PORT=$GREEN_PORT
              echo "Blue is currently active on port $BLUE_PORT, deploying Green on port $GREEN_PORT"
            elif sudo docker ps | grep -q ${{ env.CONTAINER_GREEN }}; then
              ACTIVE_CONTAINER=${{ env.CONTAINER_GREEN }}
              NEW_CONTAINER=${{ env.CONTAINER_BLUE }}
              NEW_PORT=$BLUE_PORT
              echo "Green is currently active on port $GREEN_PORT, deploying Blue on port $BLUE_PORT"
            else
              ACTIVE_CONTAINER=""
              NEW_CONTAINER=${{ env.CONTAINER_BLUE }}
              NEW_PORT=$BLUE_PORT
              echo "No active container found, deploying Blue on port $BLUE_PORT"
            fi

            # 기존에 정리가 덜 된 동일 이름 컨테이너 강제 정리
            if sudo docker ps -a | grep -q "^.*$NEW_CONTAINER\s"; then
              echo "Cleaning up existing $NEW_CONTAINER container..."
              sudo docker stop $NEW_CONTAINER || true
              sudo docker rm $NEW_CONTAINER || true
            fi
            
            echo "2. Starting New Container ($NEW_CONTAINER)..."
            # JAVA_TOOL_OPTIONS를 통해 힙 메모리 제한
            sudo docker run -d \
              --name $NEW_CONTAINER \
              --network $MYSQL_NETWORK \
              -p $NEW_PORT:8080 \
              -e JAVA_TOOL_OPTIONS="-Xmx1536m -Xms1024m" \
              --memory="2g" \
              --memory-swap="3g" \
              --restart unless-stopped \
              ${{ env.IMAGE_NAME }}:${{ github.sha }}
            
            echo "3. Health Checking..."
            HEALTH_CHECK_PASSED=false
            
            # 60s 간격으로 10회 시도 (600s)
            for i in $(seq 1 10); do
              if curl --connect-timeout 5 -s -f http://localhost:$NEW_PORT/actuator/health > /dev/null; then
                HEALTH_CHECK_PASSED=true
                echo "Health check passed at attempt $i!"
                break
              fi
              echo "Health check attempt $i failed. Retrying in 60 seconds..."
              sleep 60
            done
            
            if [ "$HEALTH_CHECK_PASSED" = "true" ]; then
              echo "4. Switching Traffic..."
              echo "server 127.0.0.1:$NEW_PORT;" | sudo tee ${{ env.NGINX_TARGET_FILE }}
              sudo nginx -t && sudo systemctl reload nginx
              
              # 기존 컨테이너 종료
              if [ ! -z "$ACTIVE_CONTAINER" ] && [ ! -z "$(sudo docker ps -q --filter "name=^${ACTIVE_CONTAINER}$")" ]; then
                echo "Waiting 15s for old container connections to drain..."
                sleep 15
                echo "Stopping old container: $ACTIVE_CONTAINER"
                sudo docker stop $ACTIVE_CONTAINER || true
                sudo docker rm $ACTIVE_CONTAINER || true
              fi
              
              # 사용 안되는 이미지 삭제 
              echo "5. Cleaning up unused images..."
              sudo docker image prune -a -f
              sudo docker builder prune -f
              echo "Blue-Green deployment completed successfully!"
              
            else
              echo "Health check failed. Check logs below:"
              sudo docker logs --tail 50 $NEW_CONTAINER
              
              echo "Rolling back..."
              sudo docker stop $NEW_CONTAINER || true
              sudo docker rm $NEW_CONTAINER || true
              exit 1
            fi
            
            # 잔여 이미지 최종 정리
            sudo docker image prune -f
