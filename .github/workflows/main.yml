name: Spring Boot Blue-Green Deploy

on:
  push:
    branches: [ master ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      SPRING_PROFILES_ACTIVE: prod
      IMAGE_NAME: igo-backend
      CONTAINER_BLUE: backend-blue
      CONTAINER_GREEN: backend-green
      NGINX_TARGET_FILE: /etc/nginx/conf.d/backend.target

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Generate application.properties from secret
        run: |
          mkdir -p ./src/main/resources
          cat <<EOF > ./src/main/resources/application.properties
          ${{ secrets.APPLICATION_PROPERTIES }}
          EOF

      - name: Generate Firebase Admin SDK JSON from secret
        run: |
          mkdir -p ./src/main/resources/firebase
          echo '${{ secrets.FIREBASE_ADMINSDK_JSON }}' > ./src/main/resources/firebase/igo-project-56559-firebase-adminsdk-fbsvc-ddd43a3897.json

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Grant execute permission to Gradle
        run: chmod +x ./gradlew

      - name: Build with Gradle (Skip Tests)
        run: ./gradlew clean build -x test --no-daemon

      - name: Build Docker Image
        run: |
          docker build -t ${{ env.IMAGE_NAME }}:${{ github.sha }} .
          docker save ${{ env.IMAGE_NAME }}:${{ github.sha }} -o backend-image.tar

      - name: Copy Docker Image to EC2
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "backend-image.tar"
          target: "/home/ubuntu/igo"

      - name: Blue-Green Deploy on EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /home/ubuntu/igo
            sudo docker load -i backend-image.tar
            rm -f backend-image.tar
            
            if ! sudo docker network ls | grep -q igo_default; then
              sudo docker network create igo_default
              echo "Created igo_default network"
            fi
            
            MYSQL_NETWORK=$(sudo docker inspect $(sudo docker ps --filter "expose=3306" -q) --format='{{range $k, $v := .NetworkSettings.Networks}}{{$k}}{{end}}' | head -1)
  
            if [ -z "$MYSQL_NETWORK" ]; then
              echo "MySQL container not found or not running!"
              exit 1
            fi
  
            echo "MySQL is running on network: $MYSQL_NETWORK"
            
            BLUE_PORT=8080
            GREEN_PORT=8081
            
            if sudo docker ps | grep -q ${{ env.CONTAINER_BLUE }}; then
              ACTIVE_CONTAINER=${{ env.CONTAINER_BLUE }}
              NEW_CONTAINER=${{ env.CONTAINER_GREEN }}
              NEW_PORT=$GREEN_PORT
            elif sudo docker ps | grep -q ${{ env.CONTAINER_GREEN }}; then
              ACTIVE_CONTAINER=${{ env.CONTAINER_GREEN }}
              NEW_CONTAINER=${{ env.CONTAINER_BLUE }}
              NEW_PORT=$BLUE_PORT
            else
              ACTIVE_CONTAINER=""
              NEW_CONTAINER=${{ env.CONTAINER_BLUE }}
              NEW_PORT=$BLUE_PORT
            fi

            if sudo docker ps -a | grep -q "^.*$NEW_CONTAINER\s"; then
              sudo docker stop $NEW_CONTAINER || true
              sudo docker rm $NEW_CONTAINER || true
            fi
            
            # 새 컨테이너 시작
           sudo docker run -d \
              --name $NEW_CONTAINER \
              --network $MYSQL_NETWORK \
              -p $NEW_PORT:8080 \
              --memory="2g" \
              --memory-swap="4g" \
              --restart unless-stopped \
              ${{ env.IMAGE_NAME }}:${{ github.sha }}
            
            HEALTH_CHECK_PASSED=false
            for i in $(seq 1 60); do
              if curl -s -f http://localhost:$NEW_PORT/actuator/health > /dev/null; then
                HEALTH_CHECK_PASSED=true
                break
              fi
              echo "Health check attempt $i failed. Retrying in 10 seconds..."
              sleep 10
            done
            
            if [ "$HEALTH_CHECK_PASSED" = "true" ]; then
              echo "server 127.0.0.1:$NEW_PORT;" | sudo tee ${{ env.NGINX_TARGET_FILE }}
              sudo nginx -t && sudo systemctl reload nginx
              
              if [ ! -z "$ACTIVE_CONTAINER" ] && [ ! -z "$(sudo docker ps -q --filter "name=^${ACTIVE_CONTAINER}$")" ]; then
                sleep 5
                sudo docker stop $ACTIVE_CONTAINER || true
                sudo docker rm $ACTIVE_CONTAINER || true
              fi
              sudo docker image prune -a -f
              sudo docker builder prune -f
            else
              sudo docker logs $NEW_CONTAINER
              sudo docker stop $NEW_CONTAINER || true
              sudo docker rm $NEW_CONTAINER || true
              exit 1
            fi
            
            sudo docker image prune -f